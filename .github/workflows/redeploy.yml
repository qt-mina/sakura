name: Bot Health Check & Auto-Redeploy

on:
  schedule:
    - cron: '*/5 * * * *'  # Runs every 5 minutes
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for recent redeploy
        id: cooldown
        run: |
          # Download the last redeploy timestamp artifact if it exists
          gh run download --name redeploy-timestamp --dir . 2>/dev/null || echo "0" > last_redeploy.txt
          
          LAST_REDEPLOY=$(cat last_redeploy.txt 2>/dev/null || echo "0")
          CURRENT_TIME=$(date +%s)
          TIME_DIFF=$((CURRENT_TIME - LAST_REDEPLOY))
          COOLDOWN_PERIOD=300  # 5 minutes in seconds
          
          if [ "$TIME_DIFF" -lt "$COOLDOWN_PERIOD" ]; then
            REMAINING=$((COOLDOWN_PERIOD - TIME_DIFF))
            echo "in_cooldown=true" >> $GITHUB_OUTPUT
            echo "remaining=$REMAINING" >> $GITHUB_OUTPUT
            echo "‚è≥ In cooldown period. $REMAINING seconds remaining until next check."
          else
            echo "in_cooldown=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send cooldown notification
        if: steps.cooldown.outputs.in_cooldown == 'true'
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          MESSAGE="‚è≥ <b>Health Check Skipped</b>
üïí Time: $TIMESTAMP
üí§ Cooldown active: ${{ steps.cooldown.outputs.remaining }}s remaining
üìù Allowing bot to fully restart"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg chat_id "${{ secrets.CHAT_ID }}" --arg text "$MESSAGE" '{chat_id: $chat_id, text: $text, parse_mode: "HTML"}')"

      - name: Check bot health
        if: steps.cooldown.outputs.in_cooldown != 'true'
        id: health
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/getMe")
          
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          if [ "$RESPONSE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            MESSAGE="‚úÖ <b>Bot Status: HEALTHY</b>
üïí Time: $TIMESTAMP
üìä HTTP Code: $RESPONSE"
          else
            echo "status=down" >> $GITHUB_OUTPUT
            MESSAGE="‚ùå <b>Bot Status: DOWN</b>
üïí Time: $TIMESTAMP
üìä HTTP Code: $RESPONSE
‚ö†Ô∏è Initiating recovery..."
          fi
          
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send status update
        if: steps.cooldown.outputs.in_cooldown != 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg chat_id "${{ secrets.CHAT_ID }}" --arg text "${{ steps.health.outputs.message }}" '{chat_id: $chat_id, text: $text, parse_mode: "HTML"}')"

      - name: Wait before redeploying
        if: steps.health.outputs.status == 'down'
        run: |
          sleep 30

      - name: Recheck bot health
        id: recheck
        if: steps.health.outputs.status == 'down'
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/getMe")
          
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          if [ "$RESPONSE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            MESSAGE="‚úÖ <b>Bot Status: RECOVERED</b>
üïí Time: $TIMESTAMP
üìä HTTP Code: $RESPONSE
üí° No redeploy needed"
          else
            echo "status=down" >> $GITHUB_OUTPUT
            MESSAGE="‚ùå <b>Bot Status: STILL DOWN</b>
üïí Time: $TIMESTAMP
üìä HTTP Code: $RESPONSE
üîÑ Triggering redeploy now..."
          fi
          
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send recheck update
        if: steps.health.outputs.status == 'down'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg chat_id "${{ secrets.CHAT_ID }}" --arg text "${{ steps.recheck.outputs.message }}" '{chat_id: $chat_id, text: $text, parse_mode: "HTML"}')"

      - name: Check for concurrent redeploy
        id: concurrency
        if: steps.health.outputs.status == 'down' && steps.recheck.outputs.status == 'down'
        run: |
          # Check if another workflow run is currently deploying
          RUNNING_WORKFLOWS=$(gh run list --workflow="${{ github.workflow }}" --status=in_progress --json databaseId --jq 'length')
          
          if [ "$RUNNING_WORKFLOWS" -gt 1 ]; then
            echo "concurrent=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Another redeploy workflow is already running. Skipping to prevent race condition."
          else
            echo "concurrent=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send concurrent workflow notification
        if: steps.concurrency.outputs.concurrent == 'true'
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          MESSAGE="‚ö†Ô∏è <b>Redeploy Skipped</b>
üïí Time: $TIMESTAMP
üîÑ Another workflow is already redeploying
‚è≥ Waiting for that to complete"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg chat_id "${{ secrets.CHAT_ID }}" --arg text "$MESSAGE" '{chat_id: $chat_id, text: $text, parse_mode: "HTML"}')"

      - name: Trigger Render Redeploy
        id: redeploy
        if: steps.health.outputs.status == 'down' && steps.recheck.outputs.status == 'down' && steps.concurrency.outputs.concurrent != 'true'
        run: |
          DEPLOY_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST ${{ secrets.REDEPLOY }})
          
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          CURRENT_TIME=$(date +%s)
          
          if [ "$DEPLOY_RESPONSE" = "200" ] || [ "$DEPLOY_RESPONSE" = "201" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            MESSAGE="üîÑ <b>Redeploy TRIGGERED</b>
üïí Time: $TIMESTAMP
üìä Deploy Response: $DEPLOY_RESPONSE
‚è≥ Bot will restart in 2-3 minutes
üí§ Health checks paused for 5 minutes"
            
            # Save redeploy timestamp
            echo "$CURRENT_TIME" > last_redeploy.txt
          else
            echo "success=false" >> $GITHUB_OUTPUT
            MESSAGE="‚ùå <b>Redeploy FAILED</b>
üïí Time: $TIMESTAMP
üìä Deploy Response: $DEPLOY_RESPONSE
üö® Manual intervention required!"
            exit 1
          fi
          
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Save redeploy timestamp
        if: steps.redeploy.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: redeploy-timestamp
          path: last_redeploy.txt
          retention-days: 1

      - name: Send redeploy status
        if: steps.health.outputs.status == 'down' && steps.recheck.outputs.status == 'down' && steps.concurrency.outputs.concurrent != 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg chat_id "${{ secrets.CHAT_ID }}" --arg text "${{ steps.redeploy.outputs.message }}" '{chat_id: $chat_id, text: $text, parse_mode: "HTML"}')"

      - name: Send workflow failure alert
        if: failure()
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          MESSAGE="üö® <b>WORKFLOW ERROR</b>
üïí Time: $TIMESTAMP
‚ö†Ô∏è Health check workflow failed
üîó Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg chat_id "${{ secrets.CHAT_ID }}" --arg text "$MESSAGE" '{chat_id: $chat_id, text: $text, parse_mode: "HTML"}')" \
            || true
